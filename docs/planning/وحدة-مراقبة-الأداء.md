# وحدة مراقبة الأداء (Performance Monitoring Unit)

تُعد وحدة مراقبة الأداء مكونًا حيويًا في `نظام الدعم الشامل`، وهي مسؤولة عن جمع، تحليل، وتصور البيانات المتعلقة بأداء النظام وموثوقيته. الهدف هو توفير رؤية شاملة وفورية لحالة النظام، مما يمكن من اتخاذ قرارات سريعة ومستنيرة.

## الغرض والأهداف

*   **الرؤية الشاملة**: توفير مقاييس أداء مفصلة لجميع مكونات النظام (STT، الترجمة، الخبراء).
*   **اكتشاف الانحرافات**: تحديد أي انحرافات عن الأداء المتوقع (مثل زيادة وقت الاستجابة، انخفاض معدل النجاح).
*   **التنبيه الاستباقي**: إطلاق تنبيهات فورية عندما تتجاوز المقاييس الحدود المحددة، مما يسمح بالتدخل قبل أن يتأثر المستخدمون.
*   **تحليل الأداء**: دعم التحليل التاريخي لتحديد الاتجاهات، وتقييم تأثير التغييرات أو التحديثات.

## المقاييس الرئيسية المراقبة (KPIs)

| المقياس (KPI) | الوصف | النظام المرتبط |
| :--- | :--- | :--- |
| **وقت الاستجابة (Latency)** | الوقت المستغرق لإكمال مهمة (مثل الترجمة أو STT). | جميع الأنظمة |
| **معدل الخطأ (Error Rate)** | نسبة الطلبات الفاشلة إلى إجمالي الطلبات. | جميع الأنظمة |
| **معدل النجاح (Success Rate)** | نسبة الطلبات المكتملة بنجاح. | جميع الأنظمة |
| **معدل أخطاء الكلمات (WER)** | مقياس دقة STT (كلما قل كان أفضل). | نظام STT المتقدم |
| **نقاط BLEU/TER** | مقاييس جودة الترجمة الآلية. | نظام محركات الترجمة المتعددة |
| **استهلاك الموارد** | استخدام وحدة المعالجة المركزية (CPU)، الذاكرة، والشبكة. | نظام إدارة الموارد |
| **وقت استخدام الخبير** | الوقت الذي يستغرقه الخبير المتخصص لإكمال مهمة. | نظام إدارة الخبراء |

## آلية العمل

1.  **جمع البيانات**: يتم جمع مقاييس الأداء من جميع مكونات النظام باستخدام أدوات المراقبة (مثل Prometheus/Grafana).
2.  **المعالجة والتخزين**: يتم معالجة البيانات وتخزينها في قاعدة بيانات متسلسلة زمنياً (Time-Series Database).
3.  **التصور (Visualization)**: يتم عرض البيانات في لوحات معلومات (Dashboards) تفاعلية تتيح للمهندسين والمشرفين مراقبة الحالة الصحية للنظام.
4.  **التنبيه (Alerting)**: يتم تكوين قواعد تنبيه بناءً على الحدود (Thresholds) المحددة.
    *   **مثال**: إذا تجاوز وقت استجابة الترجمة 5 ثوانٍ لأكثر من 5 دقائق، يتم إرسال تنبيه.
5.  **التغذية الراجعة**: يتم استخدام البيانات المجمعة لتحسين `وحدة اختيار المحرك الذكي` و`نظام إدارة الأخطاء المحكم`.

## التنفيذ التقني (مثال)

```typescript
// src/services/performanceMonitoring.ts
import { PerformanceMetric } from '../interfaces/metrics';

export class PerformanceMonitoringUnit {
  private metrics: PerformanceMetric[] = [];

  // Function to record a new metric
  recordMetric(name: string, value: number, tags: { [key: string]: string }): void {
    const metric: PerformanceMetric = {
      timestamp: Date.now(),
      name: name,
      value: value,
      tags: tags,
    };
    this.metrics.push(metric);
    this.checkAlerts(metric);
    // In a real system, this would send the metric to a time-series database
    // console.log(`Metric recorded: ${name}=${value} (${JSON.stringify(tags)})`);
  }

  // Function to check if the metric triggers an alert
  private checkAlerts(metric: PerformanceMetric): void {
    // Example Alert Rule: If translation latency exceeds 5000ms
    if (metric.name === 'translation_latency_ms' && metric.value > 5000) {
      this.sendAlert(`CRITICAL: High translation latency (${metric.value}ms) for engine: ${metric.tags.engine}`);
    }
    // Example Alert Rule: If STT Error Rate exceeds 0.05 (5%)
    if (metric.name === 'stt_error_rate' && metric.value > 0.05) {
      this.sendAlert(`WARNING: STT Error Rate is high (${(metric.value * 100).toFixed(2)}%)`);
    }
  }

  private sendAlert(message: string): void {
    // In a real system, this would send an alert via email, SMS, or PagerDuty
    console.error(`[ALERT] ${message}`);
  }

  // Function to retrieve metrics for dashboard display
  getMetrics(name?: string, timeRange?: number): PerformanceMetric[] {
    // Simplified: return all metrics
    return this.metrics.filter(m => !name || m.name === name).slice(-100);
  }
}

// Define the interface for a performance metric
export interface PerformanceMetric {
  timestamp: number;
  name: string;
  value: number;
  tags: { [key: string]: string }; // e.g., { engine: 'DeepL', domain: 'medical' }
}

export const performanceMonitoringUnit = new PerformanceMonitoringUnit();
```

من خلال المراقبة المستمرة، تضمن وحدة مراقبة الأداء أن النظام يعمل بكفاءة عالية، وأن أي مشكلات محتملة يتم اكتشافها وحلها بسرعة قبل أن تؤثر على المستخدمين.
