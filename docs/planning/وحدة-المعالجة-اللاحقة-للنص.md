# وحدة المعالجة اللاحقة للنص (Text Post-processing Unit)

تُعد وحدة المعالجة اللاحقة للنص هي الخطوة الأخيرة في عملية التحويل النصي (STT)، وهي مسؤولة عن تحسين جودة النص المكتوب وجعله جاهزًا للاستخدام في الترجمة أو العرض. تهدف هذه الوحدة إلى تحويل النص الخام الناتج عن محركات STT إلى نص مصقول، منسق، وسهل القراءة.

## الغرض والأهداف

*   **تحسين القراءة**: إضافة علامات الترقيم، وتصحيح الأخطاء النحوية والإملائية المتبقية.
*   **التنسيق الموحد**: ضمان تنسيق موحد للنص، خاصة فيما يتعلق بالأرقام، التواريخ، والوحدات.
*   **معالجة الحوار**: دمج معلومات تمييز المتحدثين في النص المكتوب لتوضيح من يتحدث متى.
*   **إعداد للترجمة**: تجهيز النص ليكون مدخلاً مثاليًا لـ `نظام محركات الترجمة المتعددة`.

## المكونات الرئيسية للوحدة

1.  **مصحيح الترقيم والإملاء (Punctuation & Spelling Corrector)**:
    *   يستخدم نماذج لغوية متقدمة لإضافة علامات الترقيم المفقودة (مثل الفواصل والنقاط وعلامات الاستفهام) وتصحيح الأخطاء الإملائية والنحوية الطفيفة.

2.  **منسق الأرقام والوحدات (Number & Unit Formatter)**:
    *   يضمن تنسيق الأرقام، التواريخ، العملات، والوحدات (مثل المتر، الكيلوغرام) بشكل صحيح ومتسق مع معايير اللغة الهدف.

3.  **وحدة دمج المتحدثين (Speaker Integration Module)**:
    *   تستخدم بيانات `وحدة تمييز المتحدثين واللغات` لإضافة علامات المتحدثين إلى النص (مثل: [المتحدث 1]: "النص...").

4.  **منسق العرض النهائي (Final Presentation Formatter)**:
    *   يقوم بتنسيق النص النهائي ليتوافق مع متطلبات العرض، مثل تقسيم النص إلى سطور مناسبة للترجمة المصاحبة (Subtitling).

## آلية العمل

1.  **استقبال النص**: تتلقى الوحدة النص الأولي الناتج عن محركات STT، بما في ذلك طوابع الوقت وبيانات المتحدثين.
2.  **تصحيح الترقيم والإملاء**: يتم تطبيق نماذج التصحيح لتحسين جودة النص اللغوية.
3.  **تنسيق العناصر**: يتم تنسيق الأرقام والتواريخ والوحدات.
4.  **إضافة المتحدثين**: يتم دمج علامات المتحدثين مع النص وفقًا لبيانات التمييز.
5.  **تقسيم للترجمة المصاحبة**: يتم تقسيم النص إلى مقاطع قصيرة ومناسبة للعرض كترجمة مصاحبة (Subtitles).
6.  **إخراج النص النهائي**: يتم إخراج النص النهائي المنسق وجاهزًا للمرحلة التالية (الترجمة).

## التنفيذ التقني (مثال)

```typescript
// src/interfaces/sttEngine.ts (Extended)
export interface FinalSTTOutput {
  segments: {
    startTime: number;
    endTime: number;
    speakerId: string;
    text: string; // Post-processed text
  }[];
  languageCode: string;
}

// src/services/textPostProcessingUnit.ts
import { STTResult, FinalSTTOutput } from '../interfaces/sttEngine';
import { DiarizationResult } from '../interfaces/audio';

export class TextPostProcessingUnit {
  async process(sttResults: STTResult[], diarizationResults: DiarizationResult[]): Promise<FinalSTTOutput> {
    console.log("Starting text post-processing...");
    const finalSegments: FinalSTTOutput['segments'] = [];

    // Assuming a 1:1 mapping between STT results and diarization results for simplicity
    for (let i = 0; i < sttResults.length; i++) {
      const stt = sttResults[i];
      const diarization = diarizationResults[i];

      // 1. Punctuation and Spelling Correction (Placeholder)
      let correctedText = this.applyPunctuationAndSpellingCorrection(stt.text);

      // 2. Number and Unit Formatting (Placeholder)
      correctedText = this.formatNumbersAndUnits(correctedText);

      // 3. Speaker Integration
      const speakerPrefixedText = `[${diarization.speakerId}]: ${correctedText}`;

      // 4. Subtitle Formatting (e.g., line breaks)
      const finalFormattedText = this.formatForSubtitle(speakerPrefixedText);

      finalSegments.push({
        startTime: diarization.startTime,
        endTime: diarization.endTime,
        speakerId: diarization.speakerId,
        text: finalFormattedText,
      });
    }

    console.log(`Finished text post-processing. Generated ${finalSegments.length} final segments.`);
    return {
      segments: finalSegments,
      languageCode: diarizationResults[0]?.languageCode || 'unknown',
    };
  }

  private applyPunctuationAndSpellingCorrection(text: string): string {
    // Placeholder for an ML-based punctuation/spelling corrector
    console.log("Applying Punctuation and Spelling Correction...");
    return text.trim().replace(/\s+/g, ' '); // Basic cleanup
  }

  private formatNumbersAndUnits(text: string): string {
    // Placeholder for number formatting logic (e.g., 1000 -> 1,000)
    console.log("Formatting numbers and units...");
    return text;
  }

  private formatForSubtitle(text: string): string {
    // Placeholder for subtitle line-breaking logic (e.g., max 40 chars per line)
    console.log("Formatting for subtitle display...");
    return text;
  }
}

export const textPostProcessingUnit = new TextPostProcessingUnit();
```

تضمن هذه الوحدة أن تكون مخرجات نظام STT المتقدم ذات جودة عالية، مما يقلل من الحاجة إلى التدخل البشري ويسرع من عملية الترجمة اللاحقة.
