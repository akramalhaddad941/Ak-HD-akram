> # نظام التحكم بالفيديو والتراكب (Video Control and Overlay System)

## 1. الوصف العام
هذا النظام مسؤول عن التفاعل المباشر مع عنصر الفيديو في صفحة الويب، والتحكم في عرض الترجمة كطبقة تراكب (Overlay) فوق الفيديو. يضمن هذا النظام المزامنة الدقيقة بين الترجمة المترجمة والصوت الأصلي.

## 2. المكونات الرئيسية

| المكون | الوظيفة | التقنية المقترحة |
| :--- | :--- | :--- |
| **وحدة اكتشاف الفيديو** | تحديد عنصر الفيديو (Video Element) في صفحة الويب والتأكد من توافقه مع الأداة. | Content Script DOM Manipulation |
| **وحدة التقاط الصوت (Audio Source)** | ربط Web Audio API بمصدر الصوت الخاص بالفيديو. | MediaStream API |
| **وحدة التراكب (Overlay Renderer)** | إنشاء عنصر HTML (باستخدام Shadow DOM) لعرض الترجمة فوق الفيديو. | React Component / Shadow DOM |
| **وحدة المزامنة الزمنية (Timing Sync)** | استخدام الـ Timestamps من نظام STT لمزامنة ظهور واختفاء الترجمة مع الكلام في الفيديو. | JavaScript Timing Functions |
| **وحدة التخصيص البصري** | تطبيق إعدادات المستخدم على مظهر التراكب (الخط، اللون، الموضع). | CSS-in-JS / React Props |

## 3. تحديات التوافق
*   **اختلاف المنصات**: كل منصة فيديو (YouTube, Netflix, إلخ) تستخدم هياكل DOM مختلفة، مما يتطلب تقنيات اكتشاف وتثبيت مرنة.
*   **حماية المحتوى**: بعض المنصات تستخدم تقنيات لمنع التقاط الصوت مباشرة، مما يتطلب حلولًا بديلة (مثل حقن سكربتات في الـ iframe).
*   **أداء العرض**: يجب أن يكون عرض التراكب خفيفًا جدًا ولا يؤثر على معدل إطارات الفيديو (FPS).

## 4. المخرجات
*   عرض سلس ومزمن للترجمة فوق الفيديو.
*   واجهة مستخدم مصغرة (Mini-UI) للتحكم في التشغيل والإيقاف المؤقت للترجمة.

# نظام التحكم بالفيديو والتراكب

يُعد نظام التحكم بالفيديو والتراكب (Video Control & Overlay System) مكونًا أساسيًا في أداة ترجمة الفيديو، حيث يتيح التفاعل المباشر مع محتوى الفيديو وعرض الترجمات والتراكبات الأخرى بشكل سلس ومزامن. يهدف هذا النظام إلى توفير تجربة مشاهدة غنية وقابلة للتخصيص للمستخدم.

## 1. أهداف النظام:

*   التحكم الكامل في تشغيل الفيديو (تشغيل، إيقاف مؤقت، تقديم، تأخير، تغيير السرعة).
*   عرض الترجمات المترجمة مباشرة على الفيديو أو في منطقة مخصصة.
*   مزامنة الترجمات بدقة مع الصوت والصورة.
*   توفير خيارات تخصيص واسعة لمظهر الترجمات (الخط، اللون، الحجم، الموضع).
*   دعم تراكبات إضافية (مثل أسماء المتحدثين، معلومات إضافية).

## 2. المكونات الرئيسية:

### 2.1. مشغل الفيديو (Video Player):

*   **`VideoPlayerController`:** واجهة للتحكم في مشغل الفيديو الأساسي (سواء كان مشغل HTML5 الأصلي أو مشغل مخصص). (مستخلص من: `المرحلةالثانيةتطويرالنواةالأساسية..md`)
*   **`PlaybackSynchronizer`:** لمزامنة تشغيل الفيديو مع الترجمات والتراكبات الأخرى. (مستخلص من: `المرحلةالثانيةتطويرالنواةالأساسية..md`)

### 2.2. نظام التراكب (Overlay System):

*   **`SubtitleRenderer`:** لعرض الترجمات على الفيديو. يجب أن يدعم أنماطًا مختلفة (CSS) ومواضع قابلة للتخصيص. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
*   **`OverlayManager`:** لإدارة طبقات التراكب المختلفة (الترجمات، أسماء المتحدثين، الإشعارات) وتحديد أولوياتها. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
*   **`CustomizableOverlay`:** مكون واجهة مستخدم يسمح للمستخدمين بتعديل مظهر التراكبات (الخط، اللون، الخلفية، الشفافية). (مستخلص من: `تعليماتالايقوناتوالصوروالشعار..md` - ضمن سياق التخصيص)

### 2.3. أدوات التفاعل مع الترجمة (Subtitle Interaction Tools):

*   **`SubtitleEditorInterface`:** واجهة رسومية لتحرير الترجمات (النص، التوقيت، التنسيق). (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
*   **`TimingAdjuster`:** أداة لضبط توقيتات الترجمة بدقة (تقديم/تأخير). (مستخلص من: `ادواتالتقاطالفيديووالصوتوالترجمةوالتحويل_251006_010620.md`)
*   **`GlossaryLookup`:** وظيفة للبحث عن معنى المصطلحات في الترجمة ضمن القواميس والمصطلحات المدمجة. (مستخلص من: `المقصودبالخبراءفيهذاالسياق.md`)

### 2.4. أدوات التحكم بالفيديو (Video Control Tools):

*   **`PlaybackControls`:** أزرار وعناصر تحكم قياسية لتشغيل/إيقاف، إيقاف مؤقت، تقديم، تأخير، تغيير مستوى الصوت. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
*   **`SpeedController`:** للتحكم في سرعة تشغيل الفيديو. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
*   **`FullScreenToggler`:** للتبديل بين وضع ملء الشاشة والوضع العادي. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)

## 3. تدفق عمل التحكم والتراكب (Control & Overlay Workflow):

1.  **تحميل الفيديو:** يتم تحميل الفيديو من المصدر المحدد (محلي، سحابي، متصفح). (مستخلص من: `استراتيجياتالوصولوالترجمة.md`)
2.  **تهيئة المشغل:** يقوم `VideoPlayerController` بتهيئة مشغل الفيديو. (مستخلص من: `المرحلةالثانيةتطويرالنواةالأساسية..md`)
3.  **تحميل الترجمات:** يتم تحميل الترجمات (الأصلية أو المترجمة) إلى `SubtitleRenderer`. (مستخلص من: `ادواتالتقاطالفيديووالصوتوالترجمةوالتحويل_251006_010620.md`)
4.  **عرض التراكب:** يقوم `OverlayManager` بعرض الترجمات والتراكبات الأخرى على الفيديو. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
5.  **المزامنة:** يقوم `PlaybackSynchronizer` بمزامنة عرض الترجمات مع تقدم الفيديو. (مستخلص من: `المرحلةالثانيةتطويرالنواةالأساسية..md`)
6.  **تفاعل المستخدم:** يتفاعل المستخدم مع عناصر التحكم بالفيديو أو الترجمات (تغيير اللغة، التعديل). (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)
7.  **تحديث العرض:** يقوم `OverlayManager` بتحديث عرض الترجمات بناءً على تفاعلات المستخدم أو التغييرات في الفيديو. (مستخلص من: `المرحلةالثالثةتطويرواجهةالمستخدم..md`)

## 4. التنفيذ التقني (Technical Implementation):

### التعريفات المطلوبة (Type Definitions):

*   يجب أن تعتمد جميع المكونات على التعريفات الموحدة الموجودة في `src/types/common.ts`.
*   قم بتوسيع هذه التعريفات حسب الحاجة لهذه المرحلة، مع إضافة أي أنواع جديدة ضرورية في ملفات أنواع مخصصة ضمن `src/types/`.

```typescript
// أمثلة على التعريفات التي يجب استخدامها/توسيعها من common.ts
import { SubtitleEntry, VideoPlaybackState, OverlayConfig } from "../../types/common";

// تعريفات إضافية قد تكون مطلوبة في هذا النظام
export interface SubtitleStyle {
  fontFamily: string;
  fontSize: string;
  color: string;
  backgroundColor: string;
  position: 'top' | 'bottom' | 'center' | 'custom';
  // ... خصائص أخرى
}

export interface VideoControlsState {
  isPlaying: boolean;
  currentTime: number;
  duration: number;
  volume: number;
  playbackSpeed: number;
}
```

### قائمة التدقيق التقني (Technical Checklist):

*   تم تصميم وتنفيذ `VideoPlayerController` و `PlaybackSynchronizer`.
*   تم تطوير `SubtitleRenderer` و `OverlayManager` لعرض الترجمات والتراكبات.
*   تم توفير واجهة لتحرير الترجمات وأدوات لضبط التوقيت.
*   تم تنفيذ أدوات التحكم الأساسية بالفيديو (تشغيل، إيقاف، سرعة).
*   تم دعم تخصيص مظهر الترجمات والتراكبات.

**الناتج المطلوب:** نظام متكامل للتحكم بالفيديو وعرض التراكبات، يوفر تجربة مشاهدة مرنة وقابلة للتخصيص، مع مزامنة دقيقة للترجمات. **العدد الإجمالي للملفات البرمجية المتوقعة لهذه الوحدة يتراوح بين 15 إلى 25 ملفًا.**

---
