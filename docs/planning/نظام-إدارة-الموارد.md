# نظام إدارة الموارد (Resource Management System)

نظام إدارة الموارد هو جزء لا يتجزأ من `نظام الدعم الشامل`، وهو مسؤول عن التوزيع الفعال والآمن لموارد الحوسبة المتاحة (مثل وحدات المعالجة المركزية، الذاكرة، وحدات معالجة الرسوميات) بين جميع مكونات النظام. الهدف هو ضمان أن جميع المهام تحصل على الموارد الكافية دون أن يتسبب أي مكون في استنزاف الموارد المتاحة، مما يؤدي إلى تباطؤ النظام.

## الغرض والأهداف

*   **التوزيع الأمثل**: تخصيص الموارد بشكل ديناميكي بناءً على احتياجات المكونات (خاصة النماذج الكبيرة مثل STT والخبراء).
*   **الحماية من الاستنزاف**: منع أي مهمة أو محرك من استهلاك جميع الموارد المتاحة، مما يضمن استقرار النظام.
*   **العدالة في التخصيص**: ضمان حصول جميع المستخدمين والمهام على حصة عادلة من الموارد.
*   **التحكم في التكلفة**: إدارة استخدام الموارد الخارجية (مثل API Calls) للتحكم في التكاليف التشغيلية.

## المكونات الرئيسية

1.  **وحدة تحديد المعدل (Rate Limiting Unit)**:
    *   تحدد عدد الطلبات التي يمكن معالجتها في فترة زمنية معينة، سواء على مستوى النظام الكلي أو على مستوى كل مستخدم/مكون.
    *   هذا يحمي الواجهات الخلفية والخدمات الخارجية من الضغط الزائد.

2.  **وحدة إدارة الحصص (Quota Management Unit)**:
    *   تراقب وتفرض حدود استخدام الموارد (مثل عدد الدقائق المعالجة شهريًا، أو عدد استدعاءات API لمحرك معين).
    *   تتكامل مع نظام الفوترة لتتبع الاستهلاك.

3.  **وحدة جدولة المهام (Task Scheduling Unit)**:
    *   تحدد أولوية تنفيذ المهام بناءً على عوامل مثل الأهمية، الوقت المتبقي، وتوافر الموارد.
    *   تضمن أن المهام ذات الأولوية العالية (مثل الترجمة في الوقت الفعلي) تحصل على الموارد اللازمة فورًا.

4.  **وحدة الموازنة الديناميكية (Dynamic Load Balancer)**:
    *   توزع طلبات العمل بين المثيلات المتاحة للمكونات (مثل عدة مثيلات من نموذج STT) لضمان الاستخدام المتساوي للموارد.

## آلية العمل

1.  **طلب الموارد**: عندما يحتاج مكون (مثل محرك STT) إلى تنفيذ مهمة، فإنه يطلب الموارد من نظام إدارة الموارد.
2.  **التحقق من الحصص والمعدل**: يقوم النظام بالتحقق من أن الطلب لا يتجاوز الحدود المحددة للمعدل والحصص.
3.  **تخصيص الموارد**: يتم تخصيص الموارد المطلوبة (مثل وقت CPU أو GPU) للمهمة.
4.  **المراقبة والإنهاء**: تتم مراقبة استهلاك الموارد أثناء تنفيذ المهمة، وإذا تجاوزت المهمة حدودها، يمكن إنهاؤها أو تقليل أولويتها.
5.  **التغذية الراجعة**: يتم إرسال بيانات الاستهلاك إلى `وحدة مراقبة الأداء` و`وحدة التغذية الراجعة والتحسين` لاتخاذ قرارات مستقبلية.

## التنفيذ التقني (مثال)

```typescript
// src/services/resourceManagement.ts

export class ResourceManagementSystem {
  private rateLimits: Map<string, { limit: number, window: number }> = new Map(); // { service: { limit: requests/sec, window: seconds } }
  private usage: Map<string, number[]> = new Map(); // { service: [timestamps] }

  constructor() {
    // Example rate limits
    this.rateLimits.set('external_translation_api', { limit: 10, window: 1 }); // 10 requests per second
    this.rateLimits.set('stt_processing', { limit: 5, window: 60 }); // 5 STT jobs per minute
  }

  // Checks if a request to a service is within the rate limit
  checkRateLimit(serviceName: string): boolean {
    const limitConfig = this.rateLimits.get(serviceName);
    if (!limitConfig) return true; // No limit defined

    const now = Date.now();
    const windowStart = now - (limitConfig.window * 1000);

    // Filter out usage outside the current window
    const currentUsage = (this.usage.get(serviceName) || []).filter(timestamp => timestamp > windowStart);

    if (currentUsage.length < limitConfig.limit) {
      // Allow the request and record the usage
      currentUsage.push(now);
      this.usage.set(serviceName, currentUsage);
      return true;
    } else {
      // Rate limit exceeded
      return false;
    }
  }

  // Placeholder for a more complex resource allocation check (CPU, GPU)
  checkResourceAllocation(resourceType: 'CPU' | 'GPU', requiredAmount: number): boolean {
    // In a real system, this would check the current load on the cluster
    // For this example, we assume infinite resources unless rate-limited
    return true;
  }

  // Main function to check if a task can be executed
  canExecuteTask(serviceName: string, requiredResources: { CPU: number, GPU: number }): boolean {
    if (!this.checkRateLimit(serviceName)) {
      console.warn(`Task execution denied for ${serviceName}: Rate limit exceeded.`);
      return false;
    }
    if (!this.checkResourceAllocation('CPU', requiredResources.CPU) || !this.checkResourceAllocation('GPU', requiredResources.GPU)) {
      console.warn(`Task execution denied for ${serviceName}: Resource allocation failed.`);
      return false;
    }
    return true;
  }
}

export const resourceManagementSystem = new ResourceManagementSystem();
```

يضمن نظام إدارة الموارد أن النظام يعمل بكفاءة عالية ويحافظ على استقراره حتى في ظل الأحمال الثقيلة، مما يساهم في تحقيق موثوقية الخدمة.
